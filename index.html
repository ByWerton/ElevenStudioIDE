<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenStudioIDE - AI Hybrid Compiler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-dark: #1e1e1e; --bg-panel: #252526; --accent: #f59e0b; --text-main: #d4d4d4; }
        body { font-family: 'JetBrains Mono', monospace; background-color: var(--bg-dark); color: var(--text-main); overflow: hidden; }
        .code-editor { background-color: var(--bg-dark); color: #dcdcaa; border: none; resize: none; outline: none; line-height: 1.6; white-space: pre; overflow-wrap: normal; overflow-x: auto; tab-size: 4; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; }
        .tab-active { background-color: #1e1e1e; border-top: 2px solid var(--accent); color: #fff; }
        .tab-inactive { background-color: #2d2d2d; color: #969696; }
        .tab-inactive:hover { background-color: #333; }
        /* ElevenStudio Özel Tema */
        .eleven-brand { background: linear-gradient(90deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
        
        /* Dosya Girişi Stili */
        input[type="file"]::file-selector-button {
            transition: all .15s ease-in-out;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-[#2d2d2d] text-white h-14 flex justify-between items-center px-4 shadow-lg border-b border-black z-20">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-yellow-500 to-orange-600 w-9 h-9 rounded flex items-center justify-center shadow-lg border border-yellow-400">
                <i class="fa-solid fa-layer-group text-white text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-base tracking-wide text-white">ElevenStudio<span class="text-yellow-500">IDE</span></h1>
                <p class="text-[10px] text-gray-400">Hybrid Compiler: Kotlin • Python • Java • C++</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="aiFixCode()" class="bg-[#3e3e3e] hover:bg-[#4e4e4e] text-yellow-500 border border-yellow-600/30 px-3 py-1.5 rounded text-xs flex items-center gap-2 transition">
                <i class="fa-solid fa-robot"></i> <span class="hidden md:inline">AI Fix</span>
            </button>
            <button onclick="togglePreview()" class="bg-[#3e3e3e] hover:bg-[#4e4e4e] text-white px-3 py-1.5 rounded text-xs flex items-center gap-2 transition border border-gray-600">
                <i class="fa-solid fa-mobile-screen"></i> <span class="hidden md:inline">Simülatör</span>
            </button>
            <button onclick="openBuildModal()" class="bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white px-5 py-1.5 rounded text-xs font-bold shadow-lg flex items-center gap-2 border border-orange-400 transition-transform active:scale-95">
                <i class="fa-brands fa-android"></i> <span class="hidden md:inline">APK OLUŞTUR</span>
            </button>
        </div>
    </header>

    <!-- Project Tabs -->
    <div class="flex bg-[#252526] text-xs select-none border-b border-[#1e1e1e] overflow-x-auto">
        <div onclick="switchTab('kotlin')" id="tab-kotlin" class="tab-active cursor-pointer px-4 py-2 flex items-center gap-2 min-w-fit border-r border-[#1e1e1e]"><i class="fa-brands fa-android text-green-400"></i> MainActivity.kt</div>
        <div onclick="switchTab('python')" id="tab-python" class="tab-inactive cursor-pointer px-4 py-2 flex items-center gap-2 min-w-fit border-r border-[#1e1e1e]"><i class="fa-brands fa-python text-yellow-400"></i> script.py</div>
        <div onclick="switchTab('java')" id="tab-java" class="tab-inactive cursor-pointer px-4 py-2 flex items-center gap-2 min-w-fit border-r border-[#1e1e1e]"><i class="fa-brands fa-java text-red-400"></i> Logic.java</div>
        <div onclick="switchTab('cpp')" id="tab-cpp" class="tab-inactive cursor-pointer px-4 py-2 flex items-center gap-2 min-w-fit border-r border-[#1e1e1e]"><i class="fa-solid fa-c text-blue-400"></i> native.cpp</div>
        <div onclick="switchTab('html')" id="tab-html" class="tab-inactive cursor-pointer px-4 py-2 flex items-center gap-2 min-w-fit border-r border-[#1e1e1e]"><i class="fa-brands fa-html5 text-orange-400"></i> index.html</div>
    </div>

    <!-- Main Workspace -->
    <main class="flex-1 relative flex overflow-hidden">
        <div class="flex-1 flex flex-col relative" id="editor-container">
            
            <!-- Kotlin Editor -->
            <textarea id="editor-kotlin" class="code-editor w-full h-full p-4 text-sm" spellcheck="false">package com.elevenstudio.app

import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity
// Bu satırı çalıştırmak için chaquopy veya benzeri bir kütüphane gerekir.
// import com.chaquo.python.Python 

class MainActivity : AppCompatActivity() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // setContentView(R.layout.activity_main) // Gerçek uygulamada UI buraya eklenmeli

        // 1. Python Script Simülasyonu (Gerçek Python kodu script.py'de)
        val pythonOutput = executePythonScript("ElevenStudio")
        println("Python Çıktısı: " + pythonOutput)

        // 2. C++ Native Çağrısı Simülasyonu
        System.loadLibrary("native-lib")
        println(stringFromJNI())
    }

    // Python Çağrısını Simüle Eden Basit Fonksiyon
    private fun executePythonScript(input: String): String {
        // Bu kısım gerçek derleyicide python/script.py dosyasını çalıştırır
        return "Simulated Python Output for $input"
    }

    external fun stringFromJNI(): String
}</textarea>

            <!-- Python Editor (NEW) -->
            <textarea id="editor-python" class="code-editor w-full h-full p-4 text-sm hidden" spellcheck="false"># ElevenStudio Python Modülü
import platform
import random

def main_function(user_name):
    """
    Bu fonksiyon Kotlin tarafından çağrılır.
    """
    greetings = ["Merhaba", "Hello", "Hola", "Selam"]
    selected = random.choice(greetings)
    
    system_info = platform.system()
    
    # Hata Düzeltme Testi: Aşağıdaki satırı kasıtlı hatalı bırakın (örn: 'pring' yazın).
    return f"{selected}, {user_name}! System: {system_info}. (Python is running inside APK)"

class DataProcessor:
    def process(self, data):
        return [d * 2 for d in data]</textarea>
            
            <!-- Java Editor -->
            <textarea id="editor-java" class="code-editor w-full h-full p-4 text-sm hidden" spellcheck="false">package com.elevenstudio.app;

public class Logic {
    public static String getLegacyData() {
        return "Java Class Loader Active.";
    }
}</textarea>

            <!-- C++ Editor -->
            <textarea id="editor-cpp" class="code-editor w-full h-full p-4 text-sm hidden" spellcheck="false">#include <jni.h>
#include <string>

extern "C" JNIEXPORT jstring JNICALL
Java_com_elevenstudio_app_MainActivity_stringFromJNI(
        JNIEnv* env,
        jobject /* this */) {
    std::string hello = "C++ Native Core Active";
    return env->NewStringUTF(hello.c_str());
}</textarea>

            <!-- HTML Editor -->
            <textarea id="editor-html" class="code-editor w-full h-full p-4 text-sm hidden" spellcheck="false"><!DOCTYPE html>
<html>
<body style="background:#111; color:white; text-align:center; font-family:sans-serif; display:flex; flex-direction:column; justify-content:center; height:100vh; margin:0;">
    <h1 style="color:#f59e0b;">ElevenStudioIDE WebView</h1>
    <p>Hybrid UI Container</p>
    <button onclick="console.log('WebView Active')" style="padding:10px; background:#f59e0b; border:none; border-radius:5px;">Test UI</button>
</body>
</html></textarea>

        </div>

        <!-- Preview Pane -->
        <div id="preview-pane" class="w-[360px] bg-black border-l border-gray-700 hidden flex-col shadow-2xl relative">
            <div class="bg-gray-800 text-white p-2 flex justify-between items-center text-xs border-b border-gray-600">
                <span><i class="fa-solid fa-mobile-screen-button text-yellow-500"></i> ElevenEmulator</span>
                <button onclick="togglePreview()" class="hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 bg-[#121212] relative overflow-hidden flex flex-col items-center justify-center">
                <iframe id="html-preview-frame" class="w-full h-full border-none pointer-events-auto opacity-50"></iframe>
                
                <!-- Logcat Overlay -->
                <div class="absolute bottom-0 w-full bg-black/90 text-green-400 text-[10px] p-2 font-mono h-40 overflow-y-auto border-t border-gray-700">
                    <div class="text-gray-500 border-b border-gray-700 mb-1 sticky top-0 bg-black">Logcat: com.elevenstudio.app</div>
                    <div id="logcat-output" class="space-y-1">
                        <div>D/Zygote: Process started...</div>
                    </div>
                </div>
            </div>
            <div class="h-12 bg-black flex justify-around items-center text-gray-500 text-lg border-t border-gray-800">
                <i class="fa-solid fa-caret-left hover:text-white"></i>
                <i class="fa-regular fa-circle hover:text-white"></i>
                <i class="fa-regular fa-square hover:text-white"></i>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-[#2d2d2d] text-gray-400 text-[11px] p-1 px-3 flex justify-between cursor-default select-none border-t border-gray-700">
        <div class="flex gap-4">
            <span id="current-lang-display" class="text-yellow-500 font-bold">Kotlin</span>
            <span><i class="fa-solid fa-check-circle"></i> ElevenStudio Engine Ready</span>
        </div>
        <div>
            <span class="mr-4">Yayınlayıcı: <strong class="text-white">ElevenStudioIDE</strong></span>
            <span>Gemini 2.5 Flash Encrypted</span>
        </div>
    </footer>

    <!-- Build Modal (Advanced) -->
    <div id="build-modal" class="fixed inset-0 bg-black/85 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-[#1e1e1e] w-full max-w-lg rounded-xl shadow-2xl border border-gray-700 overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#252526]">
                <h2 class="text-white font-bold flex items-center gap-2">
                    <i class="fa-brands fa-android text-green-500"></i> 
                    APK Yapılandırması
                </h2>
                <button onclick="closeBuildModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-6 space-y-5 overflow-y-auto max-h-[70vh]">
                
                <!-- Identity Section -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs text-gray-400 mb-1 font-bold">Uygulama Adı</label>
                        <input type="text" id="app_name" value="MyElevenApp" placeholder="Örn: SuperGame" class="w-full bg-[#111] border border-gray-600 text-white p-2.5 rounded text-sm focus:border-yellow-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 font-bold">İkon Adı (Resmi)</label>
                        <input type="text" id="icon_name" value="app_icon" placeholder="Örn: rocket" class="w-full bg-[#111] border border-gray-600 text-white p-2.5 rounded text-sm focus:border-yellow-500 outline-none transition">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs text-gray-400 mb-1 font-bold">Yapımcı (Geliştirici)</label>
                        <input type="text" id="dev_name" value="UserDev" placeholder="Adınız" class="w-full bg-[#111] border border-gray-600 text-white p-2.5 rounded text-sm focus:border-yellow-500 outline-none transition">
                    </div>
                </div>

                <!-- NEW ICON INPUT BLOCK -->
                <div class="col-span-3">
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Özel İkon Dosyası Yükle (.png)</label>
                    <input type="file" id="app_icon_file" accept="image/png" onchange="handleIconFileChange(event)" class="w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                        file:text-xs file:font-semibold
                        file:bg-yellow-600/20 file:text-yellow-400
                        hover:file:bg-yellow-600/30 transition duration-150">
                    <p id="icon-status" class="text-[10px] mt-1 text-gray-500 italic">Durum: Varsayılan ikon kullanılacak.</p>
                </div>
                
                <!-- Fixed Publisher Info -->
                <div class="bg-[#2a2a2a] p-3 rounded border border-dashed border-gray-600 flex justify-between items-center">
                    <span class="text-xs text-gray-400">Yayınlayıcı Sertifikası:</span>
                    <span class="text-sm font-bold text-yellow-500 font-mono tracking-wider">ElevenStudioIDE</span>
                    <i class="fa-solid fa-lock text-xs text-gray-500"></i>
                </div>

                <!-- Permissions Section -->
                <div>
                    <label class="block text-xs text-gray-400 mb-2 font-bold">Android İzinleri (Manifest)</label>
                    <div class="grid grid-cols-2 gap-3 bg-[#111] p-3 rounded border border-gray-700">
                        <label class="flex items-center gap-2 cursor-pointer text-gray-300 hover:text-white select-none">
                            <input type="checkbox" id="perm_internet" checked class="accent-yellow-500 w-4 h-4"> <span class="text-xs">INTERNET</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer text-gray-300 hover:text-white select-none">
                            <input type="checkbox" id="perm_camera" class="accent-yellow-500 w-4 h-4"> <span class="text-xs">CAMERA</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer text-gray-300 hover:text-white select-none">
                            <input type="checkbox" id="perm_storage" class="accent-yellow-500 w-4 h-4"> <span class="text-xs">STORAGE (R/W)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer text-gray-300 hover:text-white select-none">
                            <input type="checkbox" id="perm_location" class="accent-yellow-500 w-4 h-4"> <span class="text-xs">ACCESS_LOCATION</span>
                        </label>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="text-[10px] text-gray-500 italic">
                    * Bu işlem ElevenStudioIDE motorunu kullanarak Kotlin, Python, Java ve C++ kodlarını tek bir APK'da birleştirir. Otomatik hata düzeltme etkinleştirildi.
                </div>
            </div>

            <!-- Footer Action -->
            <div class="p-4 border-t border-gray-700 bg-[#252526] flex justify-end">
                <button onclick="startCompiler()" class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white py-3 rounded text-sm font-bold shadow-lg flex items-center justify-center gap-2 transition-all">
                    <i class="fa-solid fa-gears"></i> DERLEMEYİ BAŞLAT (APK)
                </button>
            </div>
        </div>
    </div>

    <!-- Terminal -->
    <div id="terminal" class="fixed inset-0 bg-black z-[60] hidden flex flex-col font-mono text-sm p-4 md:p-8">
        <div class="w-full max-w-4xl mx-auto bg-[#1e1e1e] border border-gray-700 rounded-lg shadow-2xl flex flex-col h-full overflow-hidden">
            <div class="bg-[#252526] p-2 flex justify-between items-center border-b border-gray-700 px-4">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                </div>
                <span class="text-xs text-gray-400">ElevenStudio Compiler Output</span>
            </div>
            <div id="terminal-content" class="flex-1 p-4 overflow-y-auto space-y-1 text-gray-300 bg-black/50"></div>
            <div class="p-4 border-t border-gray-700 bg-[#252526]">
                <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-yellow-500 h-full w-0 transition-all duration-300"></div>
                </div>
                <div class="flex justify-between mt-2">
                    <span id="status-text" class="text-xs text-yellow-500 animate-pulse">System Initializing...</span>
                    <button id="close-term-btn" onclick="closeTerminal()" class="hidden text-xs bg-red-600 hover:bg-red-700 text-white px-4 py-1 rounded transition">KAPAT</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- API SECURITY (Simpler Obfuscation) ---
        // Kullanıcının isteği üzerine, karmaşık parça parça bölme yerine tek parça Base64 kullanıldı.
        // Anahtar: AIzaSyBWudtEXXHsA0T00hyNJuOq5CRRqfAkVh0
        const ENCODED_KEY = "QUl6YVN5Qld1ZHRFWEhzAURUeE9oeU5KdU9xNUNSUlJxZkFrVmgw";
        
        function getSecureKey() { 
            return atob(ENCODED_KEY); 
        }

        let currentTab = 'kotlin';
        let appIconDataUrl = null; // Yüklenecek ikonun Data URL'sini tutar
        let appIconFileName = null; // Yüklenecek ikonun dosya adını tutar

        function switchTab(tab) {
            document.getElementById(`editor-${currentTab}`).classList.add('hidden');
            document.getElementById(`tab-${currentTab}`).classList.remove('tab-active');
            document.getElementById(`tab-${currentTab}`).classList.add('tab-inactive');
            
            currentTab = tab;
            document.getElementById(`editor-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('tab-inactive');
            
            const titles = {
                'kotlin': 'Kotlin (Android Main)',
                'python': 'Python Script (Backend)',
                'java': 'Java (Legacy)',
                'cpp': 'C++ (JNI Native)',
                'html': 'HTML (WebView Assets)'
            };
            document.getElementById('current-lang-display').innerText = titles[tab];
        }

        function togglePreview() {
            const pane = document.getElementById('preview-pane');
            const isHidden = pane.classList.contains('hidden');
            
            if (isHidden) {
                pane.classList.remove('hidden');
                pane.classList.add('flex');
                
                // HTML Load
                document.getElementById('html-preview-frame').srcdoc = document.getElementById('editor-html').value;
                
                // Logcat Simulation
                const logDiv = document.getElementById('logcat-output');
                logDiv.innerHTML += `<div class="text-blue-400">I/ElevenStudio: Python Environment Loaded.</div>`;
                setTimeout(() => {
                    logDiv.innerHTML += `<div class="text-yellow-500">I/Python: Merhaba! System: Android (Simulated)</div>`;
                }, 1000);
            } else {
                pane.classList.add('hidden');
                pane.classList.remove('flex');
            }
        }

        function openBuildModal() { document.getElementById('build-modal').classList.remove('hidden'); }
        function closeBuildModal() { document.getElementById('build-modal').classList.add('hidden'); }
        function closeTerminal() { 
            document.getElementById('terminal').classList.add('hidden'); 
            document.getElementById('terminal-content').innerHTML = ''; 
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('status-text').classList.remove('text-green-500', 'text-red-500');
            document.getElementById('status-text').classList.add('text-yellow-500', 'animate-pulse');
            document.getElementById('status-text').innerText = 'System Initializing...';
        }

        function termLog(msg, type='info') {
            const term = document.getElementById('terminal-content');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('tr-TR', {hour12:false});
            
            let color = 'text-gray-300';
            let border = 'transparent';
            
            if(type === 'success') { color = 'text-green-400'; border = '#4ade80'; }
            if(type === 'warn') { color = 'text-yellow-400'; border = '#facc15'; }
            if(type === 'error') { color = 'text-red-500'; border = '#ef4444'; }
            if(type === 'python') { color = 'text-yellow-300'; border = '#f59e0b'; } // Python özel renk

            div.className = `${color} font-mono break-all border-l-2 p-1 text-[11px] hover:bg-white/5`;
            div.style.borderColor = border;
            div.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span>${msg}`;
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
        }
        
        // ** YENİ: İkon Dosyası Yükleme İşleyicisi **
        function handleIconFileChange(event) {
            const file = event.target.files[0];
            const statusElement = document.getElementById('icon-status');
            
            if (file) {
                if (!file.type.startsWith('image/png')) {
                    statusElement.innerText = "Hata: Lütfen sadece PNG dosyası seçiniz.";
                    statusElement.classList.add('text-red-500');
                    appIconDataUrl = null;
                    return;
                }
                
                const reader = new FileReader();
                reader.onloadend = () => {
                    appIconDataUrl = reader.result;
                    appIconFileName = file.name;
                    statusElement.innerText = `Durum: İkon başarıyla yüklendi: ${file.name}`;
                    statusElement.classList.remove('text-red-500');
                    statusElement.classList.add('text-green-400');
                };
                reader.onerror = () => {
                    statusElement.innerText = "Dosya okuma hatası.";
                    statusElement.classList.add('text-red-500');
                    appIconDataUrl = null;
                };
                reader.readAsDataURL(file);
            } else {
                appIconDataUrl = null;
                appIconFileName = null;
                statusElement.innerText = "Durum: Varsayılan ikon kullanılacak.";
                statusElement.classList.remove('text-red-500', 'text-green-400');
            }
        }

        // ** Otomatik Hata Düzeltme Fonksiyonu **
        async function autoFixAndVerifyCode(codes) {
            termLog("Ön Analiz: Kod kalitesi kontrol ediliyor...", "warn");
            
            // Bu prompt'a Java da eklendi.
            const prompt = `
                ACT AS: ElevenStudio Code Reviewer and Debugger.
                CONTEXT: I am compiling a multi-language Android APK. I need you to perform a final check on Kotlin, Python, Java, and C++ code. If you find any syntax errors, type errors, or structural issues, FIX THEM. If there are no errors, return the original code blocks unchanged.
                
                TASK: Return a JSON object containing the status and the FINAL, CORRECTED code blocks.

                OUTPUT JSON ONLY:
                {
                    "status": "ok" | "fixed",
                    "log": "A summary of actions taken or confirmation if no errors were found.",
                    "kotlin": "The final corrected Kotlin code.",
                    "python": "The final corrected Python code.",
                    "java": "The final corrected Java code.",
                    "cpp": "The final corrected C++ code."
                }

                CODE BLOCKS:
                --- KOTLIN ---
                ${codes.kotlin}
                --- PYTHON ---
                ${codes.python}
                --- JAVA ---
                ${codes.java}
                --- C++ ---
                ${codes.cpp}
            `;
            
            try {
                const aiResponse = await callGemini(prompt);
                const resultText = aiResponse.replace(/```json|```/g, '').trim();
                const result = JSON.parse(resultText);

                if (result.status === "fixed") {
                    termLog(`HATA TESPİT EDİLDİ: Otomatik düzeltme uygulandı. Log: ${result.log}`, "success");
                    
                    // Editörleri düzeltilmiş kodlarla güncelle
                    document.getElementById('editor-kotlin').value = result.kotlin || codes.kotlin;
                    document.getElementById('editor-python').value = result.python || codes.python;
                    document.getElementById('editor-java').value = result.java || codes.java;
                    document.getElementById('editor-cpp').value = result.cpp || codes.cpp;
                    
                    // Manifeste hata düzeltme bilgisini eklemek için yeni kodları döndür
                    return {
                        kotlin: result.kotlin || codes.kotlin,
                        python: result.python || codes.python,
                        java: result.java || codes.java,
                        cpp: result.cpp || codes.cpp,
                        html: codes.html // HTML değişmez
                    };
                } else {
                    termLog(`Kod yapısı temiz. Hata bulunamadı.`, "info");
                    return codes; // Orijinal kodları döndür
                }
            } catch (e) {
                termLog("AI Analiz Hatası: Yapısal kontrol atlanıyor. Devam ediliyor.", "error");
                console.error("AI Analiz Hatası:", e);
                return codes;
            }
        }
        
        // Base64 Data URL'yi saf ikili verilere dönüştüren yardımcı işlev
        function dataURLtoBlob(dataurl) {
            const parts = dataurl.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);

            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], {type: contentType});
        }

        async function startCompiler() {
            closeBuildModal();
            document.getElementById('terminal').classList.remove('hidden');
            document.getElementById('close-term-btn').classList.add('hidden');
            
            // Kullanıcı verilerini al
            const appName = document.getElementById('app_name').value || "MyElevenApp";
            const devName = document.getElementById('dev_name').value || "Unknown";
            let iconName = document.getElementById('icon_name').value || "app_icon"; // İkon adı manifest için
            const publisher = "ElevenStudioIDE"; 
            
            // İzinleri topla
            let permissions = [];
            if(document.getElementById('perm_internet').checked) permissions.push("INTERNET");
            if(document.getElementById('perm_camera').checked) permissions.push("CAMERA");
            if(document.getElementById('perm_storage').checked) permissions.push("READ_EXTERNAL_STORAGE"); 
            if(document.getElementById('perm_location').checked) permissions.push("ACCESS_FINE_LOCATION");

            // Kodları al
            let codes = {
                kotlin: document.getElementById('editor-kotlin').value,
                python: document.getElementById('editor-python').value,
                java: document.getElementById('editor-java').value,
                cpp: document.getElementById('editor-cpp').value,
                html: document.getElementById('editor-html').value
            };

            try {
                termLog(`ElevenStudio Build Engine v3.0 Başlatılıyor...`, "info");
                termLog(`Metadata: App=${appName}, Dev=${devName}, Pub=${publisher}`, "info");
                document.getElementById('progress-bar').style.width = "10%";
                
                // STEP 1: Otomatik Hata Düzeltme
                codes = await autoFixAndVerifyCode(codes);

                // STEP 2: Manifest & DEX Simülasyon Analizi
                termLog("Çoklu Dil Simülasyon Analizi başlatıldı...", "warn");
                
                const prompt = `
                    ACT AS: ElevenStudio Compiler.
                    CONTEXT: Final check for APK generation.
                    TASK: Analyze the beginning of the Python code for simulated DEX generation.
                    OUTPUT JSON ONLY:
                    { "dex_hex": "Simulated DEX snippet based on Python start: ${codes.python.substring(0, 50).replace(/\n/g, ' ')}..." }
                `;

                const aiResponse = await callGemini(prompt);
                const result = JSON.parse(aiResponse.replace(/```json|```/g, '').trim());

                // STEP 3: Processing
                document.getElementById('progress-bar').style.width = "40%";
                termLog("Python bytecode (.pyc) ve DEX oluşturuluyor...", "python");
                await new Promise(r => setTimeout(r, 500));
                
                termLog("Manifesto oluşturuluyor...", "info");
                let permXML = "";
                permissions.forEach(p => permXML += `<uses-permission android:name="android.permission.${p}" />\n    `);
                
                // appIconDataUrl varsa, iconName'i de buna göre ayarlayalım
                if (appIconDataUrl) {
                    iconName = iconName.replace(/[^a-z0-9_]/g, '') || "custom_icon";
                }
                
                const fullManifest = `
<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.elevenstudio.${appName.toLowerCase().replace(/[^a-z0-9]/g, '')}">
    ${permXML}
    <application 
        android:label="${appName}" 
        android:theme="@style/Theme.Eleven"
        android:icon="@mipmap/${iconName}"
        android:roundIcon="@mipmap/${iconName}_round"
    >
        <meta-data android:name="developer" android:value="${devName}" />
        <meta-data android:name="publisher" android:value="${publisher}" />
        <activity android:name=".MainActivity" android:exported="true">
            <intent-filter><action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" /></intent-filter>
        </activity>
    </application>
</manifest>`;

                // STEP 4: APK Packaging
                document.getElementById('progress-bar').style.width = "70%";
                termLog("Varlıklar (Assets) ve Kütüphaneler paketleniyor...", "warn");
                
                const zip = new JSZip();
                zip.file("AndroidManifest.xml", fullManifest);
                zip.file("classes.dex", `// SIMULATED DEX\n${result.dex_hex}`);
                
                // Python & HTML Assetleri
                const assets = zip.folder("assets");
                assets.file("python/script.py", codes.python);
                assets.file("index.html", codes.html);

                // Yüklenen İkonu ZIP'e Ekleme
                if (appIconDataUrl) {
                    const iconBlob = dataURLtoBlob(appIconDataUrl);
                    // mipmap/ klasörüne (simülasyon) ikon dosyasını ekle
                    zip.folder("res").folder("mipmap").file(`${iconName}.png`, iconBlob, { binary: true });
                    termLog(`Özel ikon (${appIconFileName}) APK içine eklendi: res/mipmap/${iconName}.png`, "success");
                } else {
                    termLog("Özel ikon yüklenmedi. Varsayılan ikon kullanılacak.", "info");
                }

                // Native Lib
                zip.folder("lib").folder("arm64-v8a").file("libnative.so", "// ELF HEADER...");
                
                // Signature
                const meta = zip.folder("META-INF");
                meta.file("ELEVENSTUDIO.SF", `Signature-Version: v3\nCreated-By: ${publisher}\nPackage-Name: com.elevenstudio.${appName}`);

                document.getElementById('progress-bar').style.width = "90%";
                await new Promise(r => setTimeout(r, 800));

                // STEP 5: Download (.apk uzantısı ile ZIP olarak kaydediliyor)
                const blob = await zip.generateAsync({type:"blob"});
                saveAs(blob, `${appName.replace(/\s/g, '_')}_ElevenStudio.apk`); 

                document.getElementById('progress-bar').style.width = "100%";
                document.getElementById('status-text').innerText = "Derleme Tamamlandı";
                document.getElementById('status-text').classList.remove('animate-pulse');
                document.getElementById('status-text').classList.add('text-green-500');
                
                termLog("BAŞARILI: APK imzalandı ve indirildi.", "success");
                document.getElementById('close-term-btn').classList.remove('hidden');

            } catch(e) {
                termLog("KRİTİK HATA: " + (e.message || "Bilinmeyen bir hata oluştu."), "error");
                document.getElementById('status-text').innerText = "Derleme Başarısız";
                document.getElementById('status-text').classList.remove('animate-pulse', 'text-yellow-500');
                document.getElementById('status-text').classList.add('text-red-500');
                document.getElementById('close-term-btn').classList.remove('hidden');
            }
        }

        async function aiFixCode() {
            const btn = document.querySelector('button[onclick="aiFixCode()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> <span class="hidden md:inline">Analiz...</span>`;
            
            try {
                const code = document.getElementById(`editor-${currentTab}`).value;
                const prompt = `FIX the following ${currentTab} code for syntax, best practices, and runtime issues. Return ONLY the final, corrected code. Do not add any extra markdown or explanation.\n\nCODE:\n${code}`;
                const fixed = await callGemini(prompt);
                
                // Gemini'nin bazen kod bloğu içinde döndüğünü varsayarak temizle
                const finalFixedCode = fixed.replace(/```[a-z]*\n|```/gi, '').trim();

                document.getElementById(`editor-${currentTab}`).value = finalFixedCode;
                termLog(`AI tarafından '${currentTab}' kodundaki hatalar düzeltildi.`, "success");
            } catch(e) { 
                termLog("AI Düzeltme Hatası: Gemini API'a ulaşılamıyor veya yanıt geçersiz.", "error"); 
            }
            finally { btn.innerHTML = originalHTML; }
        }

        // Gemini API Çağrısı
        async function callGemini(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getSecureKey()}`;
            
            // Hata işleme ve geri çekilme (Exponential Backoff) simülasyonu
            const MAX_RETRIES = 3;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] }) 
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                            return data.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error("Gemini API'dan geçerli yanıt alınamadı.");
                        }
                    } else if (response.status === 429 && i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                        // Retry loop continues
                    } else {
                        throw new Error(`API hatası: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === MAX_RETRIES - 1) {
                        throw error;
                    }
                }
            }
        }

        window.onload = () => console.log("ElevenStudioIDE Initialized.");
    </script>
</body>
</html>

